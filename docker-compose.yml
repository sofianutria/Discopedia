services:
  murmuration-app:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: discopedia-springboot

    ports:
      - "8081:8080"

    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8080
      - DB_URL=jdbc:mysql://discopedia-db:3306/discopedia
      - DB_USERNAME=discopedia
      - DB_PASSWORD=discopedia123
      - jwt.secret.key=${JWT_SECRET_KEY}
      - JWT_EXPIRATION_TIME=1800000

    restart: unless-stopped

    depends_on:
      murmuration-db:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - discopedia-network

  murmuration-db:
    image: mysql:8.0

    container_name: discopedia-db

    environment:
      MYSQL_DATABASE: discopedia
      MYSQL_USER: discopedia
      MYSQL_PASSWORD: root
      MYSQL_ROOT_PASSWORD: root

    ports:
      - "3307:3306"

    volumes:
      - mysql_data:/var/lib/mysql

    restart: unless-stopped

    healthcheck:
      test: [
        "CMD",
        "mysqladmin",
        "ping",
        "-h",
        "localhost",
        "-u",
        "discopedia",
        "-discopedia123",
      ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - discopedia-network

networks:
  murmuration-network:
    driver: bridge

volumes:
  mysql_data: